# 項目: 網上書城

## 搭建環境
- 導入原型
    - 用戶模塊
    - 分類模塊
    - 圖書模塊
    - 購物車模塊
    - 訂單模塊

## 功能分析
- 前台
    - 用戶模塊:
        - 註冊
        - 激活
        - 登錄
        - 退出
    - 分類模塊:
        - 查看所有分類
    - 圖書模塊
        - 查詢所有圖書
        - 按分類查詢
        - 查詢圖書詳細(按 id 查)
    - 購物車模塊
        - 添加購物車條目
        - 清空所有條目
        - 刪除指定條目
        - 我的購物車(按用戶查詢購物車)
    - 訂單模塊
        - 生成訂單
        - 我的訂單(按用戶查詢訂單)
        - 按 id 查詢訂單
        - 確認收貨
        - 付款功能(只是跳轉到銀行頁面)
        - 付款回調功能(由銀行來調用這個方法，表示用戶已經付款成功)
    - 後台
        - 管理員
            - 登錄
        - 分類管理
            - 添加分類
            - 查看所有分類
            - 刪除分類
            - 按 id 查詢
            - 修改所有分類
        - 圖書管理
            - 查看所有圖書
            - 按 id 查詢
            - 刪除圖書
            - 修改圖書
            - 添加圖書(上傳圖片)
        - 訂單模塊
            - 查詢所有訂單
            - 按狀態查詢訂單
            - 發貨
            

## 框架搭建
- 導包
    - 數據庫
        - mysql 驅動
        - c3p0(jar 包和配置文件)
        - dbutils
        - itcast-tools
            - commons-beanutils
            - commons-logging
    - javamail
        - mail.jar
        - activation.jar
    - 上傳
        - commons-fileupload
        - commons-io
    - ajax
        - json-lib
- 創建 package
    - 根: pers.bookstore
        - user
            - domain
            - dao
            - service
            - web.servlet
        - category
            - domain
            - dao
            - service
            - web.servlet
        - book
            - domain
            - dao
            - service
            - web.servlet
        - cart
            - domain
            - web.servlet
        - order
            - domain
            - dao
            - service
            - web.servlet
- 表
    - t_user
    - category
    - book
    - orders
    - orderitem
![](https://github.com/jack870131/Markdown-Pic/blob/master/Picture/%E7%B6%B2%E4%B8%8A%E6%9B%B8%E5%9F%8E-%E6%95%B8%E6%93%9A%E5%BA%AB%E8%A8%AD%E8%A8%88.png?raw=true)

- 用戶模塊
    - 用戶模塊的相關類創建
        - domain: User
        - dao: UserDao
        - service: UserDao
        - web.servlet: UserServlet
    - 用戶註冊
        - 流程: /jsps/user/regist.jsp -> UserServlet#regist() -> msg.jsp
        - 頁面:
            - regist.jsp
                - 表單頁面，請求 UserServlet#regist() 方法
                - 參數: 整個表單數據
            - msg.jsp
        - Servlet:
            - UserServlet#regist()
                - 一鍵封裝表單數據到 User form 對象
                - 補全: uid、激活碼
                - 輸入校驗: 
                    - 保存錯誤信息到 request
                    - 保存當前表單數據 (form) 到 request (回顯)
                    - 轉發回到 regist.jsp
                - 調用 service 的 regist() 方法，傳遞 form 過去
                    - 如果拋出異常: 保存錯誤信息(異常信息)、保存表單數據(回顯)、轉發到 regist.jsp
                    - 如果沒有拋出異常:
                        - 發郵件(發件人、收件人、標題、內容)，內容中包含超鏈接，超鏈接指向可完成激活的 Servlet 地址。鏈接中要有機活碼參數。
                        - 保存成功信息到 request 中
                        - 轉發到 msg.jsp
        - Service:
            - UserService#regist(User user)
                - 校驗用戶是否被註冊，如果註冊，拋出 UserException
                - 校驗郵箱是否被註冊，如果註冊，拋出 UserException
                - 把 user 插入到數據庫中
        - Dao:
            - User findByUsername(String username): 按用戶名查詢用戶。
            - User findByEmail(String email): 按 email 查詢用戶。
            - void add(User form); 插入用戶到數據庫中
![](https://github.com/jack870131/Markdown-Pic/blob/master/Picture/%E7%B6%B2%E4%B8%8A%E6%9B%B8%E5%9F%8E-DAO.png?raw=true)
    - 用戶激活
        - 流程: 用戶的郵件中 -> userServlet#active() -> msg.jsp
![](https://github.com/jack870131/Markdown-Pic/blob/master/Picture/%E7%B6%B2%E4%B8%8A%E6%9B%B8%E5%9F%8E-%E7%94%A8%E6%88%B6%E6%BF%80%E6%B4%BB.png?raw=true)
    - 用戶登錄
        - 流程: /jsps/user/login.jsp -> UserServlet#login() -> index.jsp
![](https://github.com/jack870131/Markdown-Pic/blob/master/Picture/%E7%B6%B2%E4%B8%8A%E6%9B%B8%E5%9F%8E-%E7%94%A8%E6%88%B6%E7%99%BB%E9%8C%84.png?raw=true)
    - 用戶退出
        - 流程: top.jsp -> UserServlet#quit() -> login.jsp
        - quit(): 把 session 銷毀
- 分類模塊
    - 分類模塊的相關類創建
        - pers.bookstore.category
            - domain: Category
            - dao: CategoryDao
            - service: CategoryService
            - web.servlet:CategoryServlet
    - 查詢所有分類
        - 流程: main.jsp (&lt;iframe&gt;) -> CategoryService#findAll() -> left.jsp
        
- 圖書模塊
    - 創建相關類
        - pers.bookstore.book
            - domain: Book
            - dao: BookDao
            - service: BookService
            - web.servlet: BookServlet
    - 查詢所有圖書
        - 流程: left.jsp(全部分類) -> BookServlet#findAll() -> /jsps/book/list.jsp
![](https://github.com/jack870131/Markdown-Pic/blob/master/Picture/%E7%B6%B2%E4%B8%8A%E6%9B%B8%E5%9F%8E-%E6%9F%A5%E8%A9%A2%E6%89%80%E6%9C%89%E5%9C%96%E6%9B%B8.png?raw=true)
    - 按分類查詢圖書
        - 流程: left.jsp -> BookServlet#findByCategory() -> list.jsp
    - 查詢詳細信息(加載)
        - 流程: list.jsp (點擊某一本書) -> BookServlet#load() -> desc.jsp
- 購物車模塊
    - 購物車存儲
        - 保存在 session 中
        - 保存在 cookie 中
        - 保存在數據庫中
    - 創建相關類
        - 購物車結構
            - CartItem: 包含圖書和數量
            - Cart: 包含一個 Map&lt;String, CartItem&gt;
        - dao: 沒有
        - service: 沒有
        - web.servlet: 提供 CartServlet
    - 添加購物車條目
![](https://github.com/jack870131/Markdown-Pic/blob/master/Picture/%E7%B6%B2%E4%B8%8A%E6%9B%B8%E5%9F%8E-%E6%B7%BB%E5%8A%A0%E8%B3%BC%E7%89%A9%E8%BB%8A%E6%A2%9D%E7%9B%AE.png?raw=true)
    - 清空條目
![](https://github.com/jack870131/Markdown-Pic/blob/master/Picture/%E7%B6%B2%E4%B8%8A%E6%9B%B8%E5%9F%8E-%E6%B8%85%E7%A9%BA%E6%A2%9D%E7%9B%AE.png?raw=true)
    - 刪除指定條目
![](https://github.com/jack870131/Markdown-Pic/blob/master/Picture/%E7%B6%B2%E4%B8%8A%E6%9B%B8%E5%9F%8E-%E5%88%AA%E9%99%A4%E6%8C%87%E5%AE%9A%E6%A2%9D%E7%9B%AE.png?raw=true)
    - 我的購物車
        - top.jsp 中存在一個鏈接: 我的購物車
        - 我的購物車直接方問 jsps/cart/list.jsp, 他會顯示 session 中車的所有條目
- 訂單模塊
    - 創建相關類
        - domain
            - Order
            - OrderItem
        - dao: OrderDao
        - service: OrderService
        - web.servlet: OrderServlet
    - 生成訂單
![](https://github.com/jack870131/Markdown-Pic/blob/master/Picture/%E7%B6%B2%E4%B8%8A%E6%9B%B8%E5%9F%8E-%E7%94%9F%E6%88%90%E8%A8%82%E5%96%AE.png?raw=true)
    - 我的訂單(按用戶查)
![](https://github.com/jack870131/Markdown-Pic/blob/master/Picture/%E7%B6%B2%E4%B8%8A%E6%9B%B8%E5%9F%8E-%E6%88%91%E7%9A%84%E8%A8%82%E5%96%AE.png?raw=true)
    - 加載訂單(按 id 查)
![](https://github.com/jack870131/Markdown-Pic/blob/master/Picture/%E7%B6%B2%E4%B8%8A%E6%9B%B8%E5%9F%8E-%E5%8A%A0%E8%BC%89%E8%A8%82%E5%96%AE.png?raw=true)
    - 確認收貨
![](https://github.com/jack870131/Markdown-Pic/blob/master/Picture/%E7%B6%B2%E4%B8%8A%E6%9B%B8%E5%9F%8E-%E7%A2%BA%E8%AA%8D%E6%94%B6%E8%B2%A8.png?raw=true)
    - 易寶支付
        - 易寶給了個網址(支付網關)，重定向到這個網址即可
        - 還需要給這個網址後添加 13+1 個參數: https://www.yeepay.com/app-merchant-proxy/node?p0_Cmd=Buy&p1_MerId=10001126856&p2_Order=123456&p3_Amt=1234.56&p4_Cur=CNY&p5_Pid=&p6_Pcat=&p7_Pdesc=&p8_Url=http://localhost:8080/bookstore/OrderServlet?method=back&p9_SAF=&pa_MP=&pd_FrpId=ICBC-NET-B2C&pr_NeedResponse=1&hmac=dd17580a3ca176ba62d6d348583ba88b
        - 易寶回調:
            - 點對點: 易寶直接訪問電商，這裡沒有客戶端的事
                - 這種方式必須使用，這種方式是收不到的，因為我們沒有固定IP
                - 易寶有一個重發機制，如果他訪問你，你不回信息，他會一直重發。
                - 電商需要返回一個已 SUCCESS 開頭的字符串即可。
                - hmac: 13 參數值+keyValue(密鑰) + 算法(md5)
                    - 13 參數值: 自己設置
                    - keyValue: 易寶在註冊後發送給我們的，這個東西只有我們和易寶知道
                    - 底層為 md5 的算法: PaymentUtil.buildHmac( 14 個)，他返回 hmac
            - 引導客戶端瀏覽器重定向到電商。是讓客戶端訪問電商
                - 可以不使用
    - 支付(去銀行)
        - 重定向
            - 13+1 個參數
![](https://github.com/jack870131/Markdown-Pic/blob/master/Picture/%E7%B6%B2%E4%B8%8A%E6%9B%B8%E5%9F%8E-%E6%94%AF%E4%BB%98.png?raw=true)
    - 支付(銀行回饋)
    

## 後台
- 分類管理
    - 添加分類
        - 相關類創建
            - domain: Category
            - dao: CategoryDao
            - service: CategoryService
            - admin.web.servlet: AdminCategoryServlet (為管理員提供單獨的 Servlet, 然後給這個 Servlet 添加過濾器)
    - 查看所有分類
        - left.jsp 上的菜單修改指向: AdminCategoryServlet#findAll()
        - findAll():
            - 調用 service 得到所有的分類 List<Category>
            - 保存到 request 域，轉發到 /adminjsps/admin/category/list.jsp
            - list.jsp: 修改頁面，顯示所有分類
    - 添加分類
        - add.jsp(表單頁面) ->
        - AdminCategoryServlet#add():
            - 封裝表單數據
            - 補全: cid
            - 表用 service 方法完成添加工作
            - 調用 findAll() 方法
        - service#add(Category c)
        - dao#add(Category c)
    - 刪除分類
        - list.jsp (刪除鏈接) ->
        - AdminCategoryServlet#delete()
            - 獲取參數: cid
            - 調用 service 方法完成刪除
                - 如果出現異常，保存異常信息，轉發到 msg.jsp 顯示
            - 調用 findAll()
        - service#delete(String cid)
            - 通過 cid 查看該分類下的圖書本數，如果大於0, 拋出異常
            - 如果等於0, 刪除該分類
    - 修改分類
      修改分為兩部: 1. 加載分類 2. 修改分類
      第一步: 加載分類
    - list.jsp(修改鏈接) ->
    - AdminCategoryServlet#editPre()
        - 獲取 cid
        - 通過 icd 來調用 service 方法，得到 Category
        - 保存到 request 域中，轉發到 mod.jsp
      第二步: 修改分類
    - mod.jsp (提交表單) -> 
    - AdminCategoryServlet#edit()
        - 封裝表單數據
        - 調用 service 方法完成修改工作
        - 調用 findAll()
    - mod.jsp: 把當前 Category 對象顯示到表單中
    - 按 id 查詢
    - 修改所有分類
- 圖書管理
    - 相關類創建
        - web.servlet.admin:
            - AdminBookServlet
            - AdminAddBookServlet (添加圖書，包含上傳): 上傳不能使用 BaseServlet, 因為 BaseServlet 中需要使用 getParameter() 方法，而上傳 getParameter() 方法就不能再使用了。
    - 查看所有圖書
        - left.jsp (菜單項 (查看圖書鏈接)) ->
        - AdminBookServlet#findAll()
            - 查詢所有圖書，保存到 request
            - 轉發到 /adminjsps/admin/book/list.jsp
        - list.jsp: 循環遍歷所有圖書
    - 加載圖書
        - list.jsp (點擊圖名或圖片) ->
        - AdminBookServlet#load()
            - 獲取 bid, 通過 bid 調用 BookService 方法得到 Book 對象
            - 保存到 request 中，轉發到 /adminjsps/desc.jsp
        - desc.jsp: 把當前 Book 對象顯示到表單中
    - 添加圖書
      添加圖書分兩步:
      1. 加載所有分類，到 add.jsp 中顯示
        - left.jsp(菜單項: 添加圖書) ->
        - AdminBookServlet#addPre():
            - 查詢所有分類，保存到 request 域，轉發到 add.jsp
        - 在 add.jsp 中循環遍歷所有分類，顯示在 &lt;select*gt; 中。
      2. 添加圖書
        - 上傳三步:
                - 創建工廠
                - 創建解析器
                - 解析 request 得到表單字段
        - 把表單字段封裝到 Book 對象中
        - 保存上傳文件，把抱存的路徑設置給 Book 的 image 屬性
        - 調用 service 方法保存 Book 對象到數據庫中
        - 調用 findAll()
    - 刪除圖書
      book 表與 orderitem 有關連關係
      刪除圖書不是真的數據庫表中刪除紀錄，而是給 book 表添加一個 del 字段，他是 boolean 類型，表示是否已刪除
      沒有被刪除的圖書，該字段的值為 false, 否則為 true。處理問題:
        - 修改 BookDao: 所有與查詢相關的方法，都需要添加 where 條件，即 del=false
        - 修改 Book 類，添加 del 屬性
        - 刪除圖書: 其實就是把表的 del 列修改為 true
            - desc.jsp (del 按鈕) ->
                - 獲取 bid
                - 調用 service 方法完成刪除
                - 返回列表，即調用 findAll()
    - 修改圖書
        - desc.jsp(編輯按鈕) ->
        - AdminBookServlet#edit()
            - 封裝表單數據(必須讓葉面保證把 image 傳遞過來)
                - 要求頁面必須添加一個隱藏字段，把原本隱藏的圖片傳遞過來。
            - 調用 service 方法完成刪除
            - return findAll()
    - 添加圖書(上傳圖片)
